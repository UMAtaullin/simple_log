<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ë—É—Ä–æ–≤–æ–π –∂—É—Ä–Ω–∞–ª</title>
    <script src="xlsx.full.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
          sans-serif;
      }

      body {
        background: #f5f5f5;
        color: #333;
        line-height: 1.6;
      }

      .container {
        max-width: 100%;
        padding: 15px;
      }

      .header {
        background: #2c3e50;
        color: white;
        padding: 15px;
        text-align: center;
        margin-bottom: 20px;
        border-radius: 10px;
      }

      .page {
        display: none;
      }

      .page.active {
        display: block;
      }

      .card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 15px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      .form-group {
        margin-bottom: 15px;
      }

      label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #555;
      }

      input,
      select,
      textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.3s;
      }

      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: #3498db;
      }

      .btn {
        background: #3498db;
        color: white;
        border: none;
        padding: 15px 25px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        width: 100%;
        transition: background 0.3s;
        margin-bottom: 2px;
      }

      .btn:hover {
        background: #2980b9;
      }

      .btn-secondary {
        background: green;
      }

      .btn-secondary:hover {
        background: #7f8c8d;
      }

      .well-card {
        background: white;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 10px;
        border-left: 5px solid #3498db;
        cursor: pointer;
        transition: transform 0.2s;
      }

      .well-card:hover {
        transform: translateX(5px);
      }

      .well-card h3 {
        color: #2c3e50;
        margin-bottom: 5px;
      }

      .well-meta {
        color: #7f8c8d;
        font-size: 14px;
      }

      .layer-item {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        border-left: 4px solid #e74c3c;
      }

      .layer-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
      }

      .layer-depth {
        font-weight: bold;
        color: #2c3e50;
        font-size: 16px;
      }

      .layer-lithology {
        flex-grow: 1;
        margin-left: 15px;
      }

      .lithology-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
        margin-right: 8px;
      }

      .prs {
        background: #8b4513;
        color: white;
      }
      .peat {
        background: #654321;
        color: white;
      }
      .sand {
        background: #ffd700;
        color: black;
      }
      .loam {
        background: #228b22;
        color: white;
      }
      .sandy_loam {
        background: #ffa500;
        color: black;
      }

      .layer-thickness {
        color: #7f8c8d;
        font-size: 14px;
        margin-top: 5px;
      }

      .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #7f8c8d;
      }

      .action-buttons {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }

      .action-buttons .btn {
        flex: 1;
      }

      @media (max-width: 768px) {
        .container {
          padding: 10px;
        }

        .layer-info {
          flex-direction: column;
          align-items: flex-start;
        }

        .layer-lithology {
          margin-left: 0;
          margin-top: 8px;
        }
        .well-card {
          display: flex;
          align-items: flex-start;
          gap: 10px;
        }

        .btn-delete {
          background: #e74c3c;
          color: white;
          border: none;
          padding: 8px 12px;
          border-radius: 5px;
          cursor: pointer;
          font-size: 14px;
          min-width: 40px;
          height: 40px;
        }

        .btn-delete:hover {
          background: #c0392b;
        }

        .btn-delete-small {
          background: #e74c3c;
          color: white;
          border: none;
          padding: 4px 8px;
          border-radius: 3px;
          cursor: pointer;
          font-size: 12px;
          margin-left: 10px;
        }

        .btn-delete-small:hover {
          background: #c0392b;
        }

        .well-card {
          display: flex;
          align-items: center;
          gap: 10px;
          background: white;
          border-radius: 10px;
          padding: 15px;
          margin-bottom: 10px;
          border-left: 5px solid #3498db;
          cursor: pointer;
          transition: transform 0.2s;
        }

        .well-card:hover {
          transform: translateX(5px);
        }

        .layer-actions {
          display: flex;
          align-items: center;
          gap: 10px;
        }

        .layer-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
          background: #f8f9fa;
          border-radius: 8px;
          padding: 15px;
          margin-bottom: 10px;
          border-left: 4px solid #e74c3c;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üìã –ë—É—Ä–æ–≤–æ–π –∂—É—Ä–Ω–∞–ª</h1>
      </div>

      <!-- –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
      <div id="home-page" class="page active">
        <div class="card">
          <h2>–ù–æ–≤–∞—è —Å–∫–≤–∞–∂–∏–Ω–∞</h2>
          <form id="new-well-form">
            <div class="form-group">
              <label for="well-name">–ù–∞–∑–≤–∞–Ω–∏–µ —Å–∫–≤–∞–∂–∏–Ω—ã *</label>
              <input
                type="text"
                id="well-name"
                name="name"
                required
                placeholder="–°–∫–≤–∞–∂–∏–Ω–∞ ‚Ññ1"
              />
            </div>
            <div class="form-group">
              <label for="well-area">–£—á–∞—Å—Ç–æ–∫ *</label>
              <input
                type="text"
                id="well-area"
                name="area"
                required
                placeholder="–®–∏—Ñ—Ä, –º–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏–µ"
              />
            </div>
            <div class="form-group">
              <label for="well-structure">–°–æ–æ—Ä—É–∂–µ–Ω–∏–µ</label>
              <input
                type="text"
                id="well-structure"
                name="structure"
                placeholder="–ö–ü, –ê–î, –í–õ, –¢"
              />
            </div>
            <div class="form-group">
              <label for="well-depth">–ü—Ä–æ–µ–∫—Ç–Ω–∞—è –≥–ª—É–±–∏–Ω–∞ (–º) *</label>
              <input
                type="number"
                id="well-depth"
                name="planned_depth"
                step="0.1"
                placeholder="10.0"
              />
            </div>
            <button type="submit" class="btn">‚ûï –°–æ–∑–¥–∞—Ç—å —Å–∫–≤–∞–∂–∏–Ω—É</button>
          </form>
        </div>

        <div class="card">
          <h2>–ú–æ–∏ —Å–∫–≤–∞–∂–∏–Ω—ã</h2>
          <div id="wells-list">
            <div class="empty-state">
              <p>üìù –ù–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Å–∫–≤–∞–∂–∏–Ω</p>
              <p><small>–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é —Å–∫–≤–∞–∂–∏–Ω—É</small></p>
            </div>
          </div>
        </div>

        <div class="action-buttons">
          <button class="btn btn-secondary" onclick="app.exportData()">
            üìä –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
          </button>
        </div>
      </div>

      <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ä–∞–±–æ—Ç—ã —Å–æ —Å–∫–≤–∞–∂–∏–Ω–æ–π -->
      <div id="work-page" class="page">
        <div class="card">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 15px;
            "
          >
            <h2 id="working-well-name">–°–∫–≤–∞–∂–∏–Ω–∞</h2>
            <p style="font-size: 14px" id="working-well-info" class="well-meta">
              –£—á–∞—Å—Ç–æ–∫ ‚Ä¢ –°–æ–æ—Ä—É–∂–µ–Ω–∏–µ
            </p>
          </div>

          <form id="new-layer-form">
            <input type="hidden" id="current-well-id" name="well_id" />

            <div style="display: flex; gap: 10px; margin-bottom: 15px">
              <div class="form-group" style="flex: 1">
                <label for="depth-from">–û—Ç (–º)</label>
                <input
                  type="number"
                  id="depth-from"
                  name="depth_from"
                  step="0.1"
                  placeholder="0.0"
                />
              </div>
              <div class="form-group" style="flex: 1">
                <label for="depth-to">–î–æ (–º)</label>
                <input
                  type="number"
                  id="depth-to"
                  name="depth_to"
                  step="0.1"
                  placeholder="2.5"
                />
              </div>
            </div>

            <div class="form-group">
              <label for="lithology">–õ–∏—Ç–æ–ª–æ–≥–∏—è</label>
              <select id="lithology" name="lithology" required>
                <option value="prs">üü´ –ü–†–°</option>
                <option value="peat">üü§ –¢–æ—Ä—Ñ</option>
                <option value="sand">üü° –ü–µ—Å–æ–∫</option>
                <option value="loam">üîµ –°—É–≥–ª–∏–Ω–æ–∫</option>
                <option value="sandy_loam">üü† –°—É–ø–µ—Å—å</option>
              </select>
            </div>

            <div class="form-group">
              <label for="description">–û–ø–∏—Å–∞–Ω–∏–µ</label>
              <textarea
                id="description"
                name="description"
                rows="2"
                placeholder="–¶–≤–µ—Ç, –≤–ª–∞–∂–Ω–æ—Å—Ç—å, –≤–∫–ª—é—á–µ–Ω–∏—è..."
              ></textarea>
            </div>

            <button type="submit" class="btn">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–π</button>
            <button class="btn btn-secondary" onclick="showPage('home-page')">
              –ù–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
            </button>
          </form>
        </div>

        <div class="card">
          <h3>üìä –ì–µ–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Å–ª–æ–∏ <span id="current-well-name"></span></h3>
          <div id="layers-list">
            <div class="empty-state">
              <p>üìù –ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å–ª–æ–µ–≤</p>
              <p><small>‚ûï –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π —Å–ª–æ–π</small></p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      class DrillingJournal {
        constructor() {
          this.dbName = 'DrillingJournal'
          this.dbVersion = 1
          this.currentWell = null
          this.init()
        }

        async init() {
          await this.initDB()
          this.setupEventListeners()
          this.loadWells()
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        async initDB() {
          return new Promise((resolve, reject) => {
            const request = indexedDB.open(this.dbName, this.dbVersion)

            request.onerror = () => reject(request.error)
            request.onsuccess = () => {
              this.db = request.result
              console.log('‚úÖ –ë–î –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞')
              resolve()
            }

            request.onupgradeneeded = (event) => {
              const db = event.target.result

              if (!db.objectStoreNames.contains('wells')) {
                const wellStore = db.createObjectStore('wells', {
                  keyPath: 'id',
                })
                wellStore.createIndex('name', 'name', { unique: false })
              }

              if (!db.objectStoreNames.contains('layers')) {
                const layerStore = db.createObjectStore('layers', {
                  keyPath: 'id',
                })
                layerStore.createIndex('wellId', 'wellId', { unique: false })
              }
            }
          })
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
        setupEventListeners() {
          // –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–∫–≤–∞–∂–∏–Ω—ã
          const wellForm = document.getElementById('new-well-form')
          if (wellForm) {
            wellForm.addEventListener('submit', (e) => {
              e.preventDefault()
              this.createWell(new FormData(e.target))
            })
          }

          // –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–ª–æ—è
          const layerForm = document.getElementById('new-layer-form')
          if (layerForm) {
            layerForm.addEventListener('submit', (e) => {
              e.preventDefault()
              this.createLayer(new FormData(e.target))
            })
          }
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –ë–î
        async saveToLocalDB(storeName, data) {
          return new Promise((resolve, reject) => {
            const transaction = this.db.transaction([storeName], 'readwrite')
            const store = transaction.objectStore(storeName)

            const itemWithId = {
              ...data,
              id:
                data.id ||
                `local_${Date.now()}_${Math.random()
                  .toString(36)
                  .substr(2, 9)}`,
              createdAt: new Date().toISOString(),
            }

            const request = store.put(itemWithId)

            request.onsuccess = () => resolve(itemWithId)
            request.onerror = (e) => reject(e)
          })
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î
        async loadFromLocalDB(storeName, indexName = null, value = null) {
          return new Promise((resolve, reject) => {
            const transaction = this.db.transaction([storeName], 'readonly')
            const store = transaction.objectStore(storeName)
            let request

            if (indexName && value !== null) {
              const index = store.index(indexName)
              request = index.getAll(value)
            } else {
              request = store.getAll()
            }

            request.onsuccess = () => resolve(request.result)
            request.onerror = (e) => reject(e)
          })
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ —Å–∫–≤–∞–∂–∏–Ω—ã
        async createWell(formData) {
          const wellData = {
            name: formData.get('name'),
            area: formData.get('area'),
            structure: formData.get('structure'),
            planned_depth: parseFloat(formData.get('planned_depth')) || 0,
          }

          try {
            await this.saveToLocalDB('wells', wellData)
            this.showMessage('‚úÖ –°–∫–≤–∞–∂–∏–Ω–∞ —Å–æ–∑–¥–∞–Ω–∞!', 'success')
            document.getElementById('new-well-form').reset()
            this.loadWells()
          } catch (error) {
            this.showMessage('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–∫–≤–∞–∂–∏–Ω—ã', 'error')
          }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ —Å–ª–æ—è
        async createLayer(formData) {
          const wellId = formData.get('well_id')
          const depthFrom = parseFloat(formData.get('depth_from'))
          const depthTo = parseFloat(formData.get('depth_to'))

          // –í–ê–õ–ò–î–ê–¶–ò–Ø
          if (isNaN(depthFrom) || isNaN(depthTo)) {
            this.showMessage('‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≥–ª—É–±–∏–Ω—ã', 'error')
            return
          }

          if (depthFrom >= depthTo) {
            this.showMessage(
              '‚ùå –ì–ª—É–±–∏–Ω–∞ "–æ—Ç" –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –º–µ–Ω—å—à–µ –≥–ª—É–±–∏–Ω—ã "–¥–æ"',
              'error'
            )
            return
          }

          const layerData = {
            wellId: wellId,
            depth_from: depthFrom,
            depth_to: depthTo,
            lithology: formData.get('lithology'),
            description: formData.get('description'),
            thickness: (depthTo - depthFrom).toFixed(2),
          }

          try {
            await this.saveToLocalDB('layers', layerData)
            this.showMessage('‚úÖ –°–ª–æ–π –¥–æ–±–∞–≤–ª–µ–Ω!', 'success')
            document.getElementById('new-layer-form').reset()
            await this.loadWellLayers(wellId)
          } catch (error) {
            this.showMessage('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Å–ª–æ—è', 'error')
          }
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∫–ª–∞—Å—Å DrillingJournal:

        // –£–¥–∞–ª–µ–Ω–∏–µ —Å–∫–≤–∞–∂–∏–Ω—ã
        async deleteWell(wellId) {
          if (!confirm('–£–¥–∞–ª–∏—Ç—å —Å–∫–≤–∞–∂–∏–Ω—É –∏ –≤—Å–µ –µ—ë —Å–ª–æ–∏?')) return

          try {
            // –£–¥–∞–ª—è–µ–º —Å–∫–≤–∞–∂–∏–Ω—É
            await this.deleteFromLocalDB('wells', wellId)

            // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å–ª–æ–∏ —ç—Ç–æ–π —Å–∫–≤–∞–∂–∏–Ω—ã
            const allLayers = await this.loadFromLocalDB('layers')
            const wellLayers = allLayers.filter(
              (layer) => layer.wellId === wellId
            )

            for (const layer of wellLayers) {
              await this.deleteFromLocalDB('layers', layer.id)
            }

            this.showMessage('‚úÖ –°–∫–≤–∞–∂–∏–Ω–∞ —É–¥–∞–ª–µ–Ω–∞', 'success')
            this.loadWells()
          } catch (error) {
            this.showMessage('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏', 'error')
          }
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ —Å–ª–æ—è
        async deleteLayer(layerId) {
          if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Å–ª–æ–π?')) return

          try {
            await this.deleteFromLocalDB('layers', layerId)
            this.showMessage('‚úÖ –°–ª–æ–π —É–¥–∞–ª–µ–Ω', 'success')
            this.loadWellLayers(this.currentWell)
          } catch (error) {
            this.showMessage('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏', 'error')
          }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–∫–≤–∞–∂–∏–Ω
        async loadWells() {
          try {
            const wells = await this.loadFromLocalDB('wells')
            this.renderWells(wells)
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫–≤–∞–∂–∏–Ω:', error)
          }
        }

        // –ú–ï–¢–û–î –£–î–ê–õ–ï–ù–ò–Ø –ò–ó –õ–û–ö–ê–õ–¨–ù–û–ô –ë–î
        async deleteFromLocalDB(storeName, id) {
          return new Promise((resolve, reject) => {
            const transaction = this.db.transaction([storeName], 'readwrite')
            const store = transaction.objectStore(storeName)
            const request = store.delete(id)

            request.onsuccess = () => {
              console.log(`üóëÔ∏è –£–¥–∞–ª–µ–Ω –∏–∑ ${storeName}:`, id)
              resolve()
            }
            request.onerror = (e) => {
              console.error(`‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ ${storeName}:`, e)
              reject(e)
            }
          })
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ª–æ–µ–≤ —Å–∫–≤–∞–∂–∏–Ω—ã
        async loadWellLayers(wellId) {
          try {
            const layers = await this.loadFromLocalDB(
              'layers',
              'wellId',
              wellId
            )
            this.renderLayers(layers)
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ–µ–≤:', error)
          }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–∫–≤–∞–∂–∏–Ω
        renderWells(wells) {
          const container = document.getElementById('wells-list')

          if (!wells || wells.length === 0) {
            container.innerHTML = `
                        <div class="empty-state">
                            <p>üìù –ù–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Å–∫–≤–∞–∂–∏–Ω</p>
                            <p><small>–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é —Å–∫–≤–∞–∂–∏–Ω—É</small></p>
                        </div>
                    `
            return
          }

          container.innerHTML = wells
            .map(
              (well) => `
              <div class="well-card">
                  <div onclick="app.showWorkPage('${
                    well.id
                  }')" style="flex-grow: 1;">
                      <h3>${well.name}</h3>
                      <div class="well-meta">
                          <p>üìç ${well.area}</p>
                          ${well.structure ? `<p>üèóÔ∏è ${well.structure}</p>` : ''}
                          ${
                            well.planned_depth
                              ? `<p>üìè ${well.planned_depth} –º</p>`
                              : ''
                          }
                      </div>
                      <small>üìÖ ${new Date(well.createdAt).toLocaleDateString(
                        'ru-RU'
                      )}</small>
                  </div>
                  <button class="btn-delete" onclick="app.deleteWell('${
                    well.id
                  }')" title="–£–¥–∞–ª–∏—Ç—å —Å–∫–≤–∞–∂–∏–Ω—É">üóëÔ∏è</button>
              </div>
          `
            )
            .join('')
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ª–æ–µ–≤
        renderLayers(layers) {
          const container = document.getElementById('layers-list')

          if (!layers || layers.length === 0) {
            container.innerHTML = `
                        <div class="empty-state">
                            <p>üìù –ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å–ª–æ–µ–≤</p>
                            <p><small>–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π —Å–ª–æ–π</small></p>
                        </div>
                    `
            return
          }

          // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Å–ª–æ–∏ –ø–æ –≥–ª—É–±–∏–Ω–µ
          layers.sort(
            (a, b) => parseFloat(a.depth_from) - parseFloat(b.depth_from)
          )

          container.innerHTML = layers
            .map(
              (layer) => `
              <div class="layer-item">
                  <div class="layer-info">
                      <div class="layer-depth">
                          ${layer.depth_from} - ${layer.depth_to} –º
                      </div>
                      <div class="layer-lithology">
                          <span class="lithology-badge ${layer.lithology}">
                              ${this.getLithologyDisplay(layer.lithology)}
                          </span>
                          ${layer.description || ''}
                      </div>
                  </div>
                  <div class="layer-actions">
                      <div class="layer-thickness">
                          ${layer.thickness} –º
                      </div>
                      <button class="btn-delete-small" onclick="app.deleteLayer('${
                        layer.id
                      }')" title="–£–¥–∞–ª–∏—Ç—å —Å–ª–æ–π">üóëÔ∏è</button>
                  </div>
              </div>
          `
            )
            .join('')
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏—è –ª–∏—Ç–æ–ª–æ–≥–∏–∏
        getLithologyDisplay(lithology) {
          const lithologyMap = {
            prs: '–ü–†–°',
            peat: '–¢–æ—Ä—Ñ',
            sand: '–ü–µ—Å–æ–∫',
            loam: '–°—É–≥–ª–∏–Ω–æ–∫',
            sandy_loam: '–°—É–ø–µ—Å—å',
          }
          return lithologyMap[lithology] || lithology
        }

        // –ü–æ–∫–∞–∑ —Å–æ–æ–±—â–µ–Ω–∏–π
        showMessage(text, type = 'info') {
          // –ü—Ä–æ—Å—Ç–æ–π alert –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
          alert(text)
        }

        // –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
        async exportData() {
          try {
            const wells = await this.loadFromLocalDB('wells')
            const layers = await this.loadFromLocalDB('layers')

            if (wells.length === 0) {
              this.showMessage('‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'error')
              return
            }

            // –°–æ–∑–¥–∞–µ–º Excel —Ñ–∞–π–ª
            const workbook = this.createExcelWorkbook(wells, layers)

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏ —Å–∫–∞—á–∏–≤–∞–µ–º
            this.downloadExcel(workbook, '–±—É—Ä–æ–≤–æ–π_–∂—É—Ä–Ω–∞–ª.xlsx')

            this.showMessage('‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω!', 'success')
          } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:', error)
            this.showMessage('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –¥–∞–Ω–Ω—ã—Ö', 'error')
          }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ Excel —Ñ–∞–π–ª–∞
        createExcelWorkbook(wells, layers) {
          const workbook = XLSX.utils.book_new()

          // –õ–∏—Å—Ç —Å–æ —Å–∫–≤–∞–∂–∏–Ω–∞–º–∏
          const wellsData = wells.map((well) => ({
            –ù–∞–∑–≤–∞–Ω–∏–µ: well.name,
            –£—á–∞—Å—Ç–æ–∫: well.area,
            –°–æ–æ—Ä—É–∂–µ–Ω–∏–µ: well.structure || '',
            '–ü—Ä–æ–µ–∫—Ç–Ω–∞—è –≥–ª—É–±–∏–Ω–∞, –º': well.planned_depth || 0,
            '–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è': new Date(well.createdAt).toLocaleDateString(
              'ru-RU'
            ),
          }))

          const wellsSheet = XLSX.utils.json_to_sheet(wellsData)
          XLSX.utils.book_append_sheet(workbook, wellsSheet, '–°–∫–≤–∞–∂–∏–Ω—ã')

          // –õ–∏—Å—Ç —Å–æ —Å–ª–æ—è–º–∏
          const wellMap = {}
          wells.forEach((well) => {
            wellMap[well.id] = well.name
          })

          const layersData = layers.map((layer) => ({
            –°–∫–≤–∞–∂–∏–Ω–∞: wellMap[layer.wellId] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
            '–ì–ª—É–±–∏–Ω–∞ –æ—Ç, –º': layer.depth_from,
            '–ì–ª—É–±–∏–Ω–∞ –¥–æ, –º': layer.depth_to,
            '–ú–æ—â–Ω–æ—Å—Ç—å, –º': layer.thickness,
            –õ–∏—Ç–æ–ª–æ–≥–∏—è: this.getLithologyDisplay(layer.lithology),
            –û–ø–∏—Å–∞–Ω–∏–µ: layer.description || '',
            '–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è': new Date(layer.createdAt).toLocaleDateString(
              'ru-RU'
            ),
          }))

          const layersSheet = XLSX.utils.json_to_sheet(layersData)
          XLSX.utils.book_append_sheet(
            workbook,
            layersSheet,
            '–ì–µ–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Å–ª–æ–∏'
          )

          return workbook
        }

        // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ Excel —Ñ–∞–π–ª–∞
        downloadExcel(workbook, filename) {
          const excelBuffer = XLSX.write(workbook, {
            bookType: 'xlsx',
            type: 'array',
          })

          const blob = new Blob([excelBuffer], {
            type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
          })

          const url = URL.createObjectURL(blob)
          const link = document.createElement('a')
          link.href = url
          link.download = filename
          document.body.appendChild(link)
          link.click()
          document.body.removeChild(link)
          URL.revokeObjectURL(url)
        }

        // –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–∞–±–æ—Ç—ã —Å–æ —Å–∫–≤–∞–∂–∏–Ω–æ–π
        async showWorkPage(wellId) {
          this.currentWell = wellId
          document.getElementById('current-well-id').value = wellId

          await this.loadWellDetails(wellId)
          await this.loadWellLayers(wellId)
          showPage('work-page')
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–µ—Ç–∞–ª–µ–π —Å–∫–≤–∞–∂–∏–Ω—ã
        async loadWellDetails(wellId) {
          try {
            const wells = await this.loadFromLocalDB('wells')
            const well = wells.find((w) => w.id === wellId)

            if (well) {
              document.getElementById('working-well-name').textContent =
                well.name
              document.getElementById('working-well-info').textContent = `${
                well.area
              }${well.structure ? ' ‚Ä¢ ' + well.structure : ''}`
              document.getElementById('current-well-name').textContent =
                well.name
            }
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π —Å–∫–≤–∞–∂–∏–Ω—ã:', error)
          }
        }
      }

      // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
      function showPage(pageId) {
        document.querySelectorAll('.page').forEach((page) => {
          page.classList.remove('active')
        })
        document.getElementById(pageId).classList.add('active')
      }

      function exportData() {
        app.exportData()
      }

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
      let app
      document.addEventListener('DOMContentLoaded', () => {
        app = new DrillingJournal()
      })
    </script>
  </body>
</html>
