<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ë—É—Ä–æ–≤–æ–π –∂—É—Ä–Ω–∞–ª</title>
    <script>
      // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å CDN, –µ—Å–ª–∏ –Ω–µ—Ç - –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é
      const script = document.createElement('script');
      script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
      script.onerror = function() {
          const localScript = document.createElement('script');
          localScript.src = 'xlsx.full.min.js';
          document.head.appendChild(localScript);
      };
      document.head.appendChild(script);
    </script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
          sans-serif;
      }

      body {
        background: #f5f5f5;
        color: #333;
        line-height: 1.6;
      }

      .container {
        max-width: 100%;
        padding: 15px;
      }

      .header {
        background: #2c3e50;
        color: white;
        padding: 15px;
        text-align: center;
        margin-bottom: 20px;
        border-radius: 10px;
      }

      .page {
        display: none;
      }

      .page.active {
        display: block;
      }

      .card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 15px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      .form-group {
        margin-bottom: 15px;
      }

      label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #555;
      }

      input,
      select,
      textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.3s;
      }

      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: #3498db;
      }

      .btn {
        background: #3498db;
        color: white;
        border: none;
        padding: 15px 25px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        width: 100%;
        transition: background 0.3s;
        margin-bottom: 2px;
      }

      .btn:hover {
        background: #2980b9;
      }

      .btn-secondary {
        background: green;
      }

      .btn-secondary:hover {
        background: #7f8c8d;
      }

      .well-card {
        background: white;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 10px;
        border-left: 5px solid #3498db;
        cursor: pointer;
        transition: transform 0.2s;
      }

      .well-card:hover {
        transform: translateX(5px);
      }

      .well-card h3 {
        color: #2c3e50;
        margin-bottom: 5px;
      }

      .well-meta {
        color: #7f8c8d;
        font-size: 14px;
      }

      .layer-item {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        border-left: 4px solid #e74c3c;
      }

      .layer-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
      }

      .layer-depth {
        font-weight: bold;
        color: #2c3e50;
        font-size: 16px;
      }

      .layer-lithology {
        flex-grow: 1;
        margin-left: 15px;
      }

      .lithology-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
        margin-right: 8px;
      }

      .prs {
        background: #8b4513;
        color: white;
      }
      .peat {
        background: #654321;
        color: white;
      }
      .sand {
        background: #ffd700;
        color: black;
      }
      .loam {
        background: #228b22;
        color: white;
      }
      .sandy_loam {
        background: #ffa500;
        color: black;
      }

      .layer-thickness {
        color: #7f8c8d;
        font-size: 14px;
        margin-top: 5px;
      }

      .empty-state {
        text-align: center;
        padding: 30px 20px;
        color: #7f8c8d;
      }

      .action-buttons {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }

      .action-buttons .btn {
        flex: 1;
      }

      @media (max-width: 768px) {
        .container {
          padding: 10px;
        }

        .layer-info {
          flex-direction: column;
          align-items: flex-start;
        }

        .layer-lithology {
          margin-left: 0;
          margin-top: 8px;
        }
        .well-card {
          display: flex;
          align-items: flex-start;
          gap: 10px;
        }

        .btn-delete {
          background: #e74c3c;
          color: white;
          border: none;
          padding: 8px 12px;
          border-radius: 5px;
          cursor: pointer;
          font-size: 14px;
          min-width: 40px;
          height: 40px;
        }

        .btn-delete:hover {
          background: #c0392b;
        }

        .btn-delete-small {
          background: #e74c3c;
          color: white;
          border: none;
          padding: 4px 8px;
          border-radius: 3px;
          cursor: pointer;
          font-size: 12px;
          margin-left: 10px;
        }

        .btn-delete-small:hover {
          background: #c0392b;
        }

        .well-card {
          display: flex;
          align-items: center;
          gap: 10px;
          background: white;
          border-radius: 10px;
          padding: 15px;
          margin-bottom: 10px;
          border-left: 5px solid #3498db;
          cursor: pointer;
          transition: transform 0.2s;
        }

        .well-card:hover {
          transform: translateX(5px);
        }

        .layer-actions {
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 10px;
        }

        .layer-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
          background: #f8f9fa;
          border-radius: 8px;
          padding: 15px;
          margin-bottom: 10px;
          border-left: 4px solid #e74c3c;
        }

        .btn-edit-small {
          background: #3498db;
          color: white;
          border: none;
          padding: 4px 8px;
          border-radius: 3px;
          cursor: pointer;
          font-size: 12px;
          margin-left: 5px;
        }

        .btn-edit-small:hover {
          background: #2980b9;
        }

        .layer-core {
          color: #27ae60;
          font-size: 14px;
          font-weight: 500;
          margin-top: 5px;
          line-height: 1.4;
        }

        .core-interval-item {
          display: flex;
          gap: 8px;
          margin-bottom: 10px;
          align-items: center;
          padding: 10px;
          background: #f8f9fa;
          border-radius: 5px;
        }

        .core-interval-item div {
          flex: 1;
        }

        .core-interval-item div:last-child {
          flex: 0.8;
        }

        /* –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
        @media (max-width: 768px) {
          .core-interval-item {
            flex-direction: column;
            gap: 5px;
          }

          .core-interval-item div {
            width: 100%;
          }
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üìã –ë—É—Ä–æ–≤–æ–π –∂—É—Ä–Ω–∞–ª</h1>
      </div>

      <!-- –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
      <div id="home-page" class="page active">
        <div class="card">
          <h2>–ù–æ–≤–∞—è —Å–∫–≤–∞–∂–∏–Ω–∞</h2>
          <form id="new-well-form">
            <div class="form-group">
              <label for="well-name">–ù–∞–∑–≤–∞–Ω–∏–µ —Å–∫–≤–∞–∂–∏–Ω—ã *</label>
              <input
                type="text"
                id="well-name"
                name="name"
                required
                placeholder="–°–∫–≤–∞–∂–∏–Ω–∞ ‚Ññ1"
              />
            </div>
            <div class="form-group">
              <label for="well-area">–£—á–∞—Å—Ç–æ–∫ *</label>
              <input
                type="text"
                id="well-area"
                name="area"
                required
                placeholder="–®–∏—Ñ—Ä, –º–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏–µ"
              />
            </div>
            <div class="form-group">
              <label for="well-structure">–°–æ–æ—Ä—É–∂–µ–Ω–∏–µ</label>
              <input
                type="text"
                id="well-structure"
                name="structure"
                placeholder="–ö–ü, –ê–î, –í–õ, –¢"
              />
            </div>
            <div class="form-group">
              <label for="well-depth">–ü—Ä–æ–µ–∫—Ç–Ω–∞—è –≥–ª—É–±–∏–Ω–∞ (–º)</label>
              <input
                type="number"
                id="well-depth"
                name="planned_depth"
                step="0.1"
                placeholder="10.0"
              />
            </div>
            <button type="submit" class="btn">‚ûï –°–æ–∑–¥–∞—Ç—å —Å–∫–≤–∞–∂–∏–Ω—É</button>
            <button class="btn btn-secondary" onclick="app.exportData()">
            üìä –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
          </button>
          </form>
        </div>

        <div class="card">
          <h2>–ú–æ–∏ —Å–∫–≤–∞–∂–∏–Ω—ã</h2>
          <div id="wells-list">
            <div class="empty-state">
              <p>üìù –ù–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Å–∫–≤–∞–∂–∏–Ω</p>
              <p><small>–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é —Å–∫–≤–∞–∂–∏–Ω—É</small></p>
            </div>
          </div>
        </div>
      </div>

      <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ä–∞–±–æ—Ç—ã —Å–æ —Å–∫–≤–∞–∂–∏–Ω–æ–π -->
      <div id="work-page" class="page">
        <div class="card">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 15px;
            "
          >
            <h2 id="working-well-name">–°–∫–≤–∞–∂–∏–Ω–∞</h2>
            <p style="font-size: 14px" id="working-well-info" class="well-meta">
              –£—á–∞—Å—Ç–æ–∫ ‚Ä¢ –°–æ–æ—Ä—É–∂–µ–Ω–∏–µ
            </p>
          </div>

          <form id="new-layer-form">
            <input type="hidden" id="current-well-id" name="well_id" />

            <div style="display: flex; gap: 10px; margin-bottom: 15px">
              <div class="form-group" style="flex: 1">
                <label for="depth-from">–û—Ç (–º)</label>
                <input
                  type="number"
                  id="depth-from"
                  name="depth_from"
                  step="0.1"
                  placeholder="0.0"
                />
              </div>
              <div class="form-group" style="flex: 1">
                <label for="depth-to">–î–æ (–º)</label>
                <input
                  type="number"
                  id="depth-to"
                  name="depth_to"
                  step="0.1"
                  placeholder="0.2"
                />
              </div>
            </div>

            <div class="form-group">
              <label for="lithology">–õ–∏—Ç–æ–ª–æ–≥–∏—è</label>
              <select id="lithology" name="lithology" required>
                <option value="prs">üü´ –ü–†–°</option>
                <option value="peat">üü§ –¢–æ—Ä—Ñ</option>
                <option value="sand">üü° –ü–µ—Å–æ–∫</option>
                <option value="loam">üîµ –°—É–≥–ª–∏–Ω–æ–∫</option>
                <option value="sandy_loam">üü† –°—É–ø–µ—Å—å</option>
              </select>
            </div>

            <div class="form-group">
              <label for="description">–û–ø–∏—Å–∞–Ω–∏–µ</label>
              <textarea
                id="description"
                name="description"
                rows="2"
                placeholder="–¶–≤–µ—Ç, –≤–ª–∞–∂–Ω–æ—Å—Ç—å, –≤–∫–ª—é—á–µ–Ω–∏—è..."
              ></textarea>
            </div>

            <button type="submit" class="btn">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–π</button>
            <button class="btn btn-secondary" onclick="showPage('home-page')">
              –ù–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
            </button>
          </form>
        </div>

        <div class="card">
          <h3>üìä –ì–µ–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Å–ª–æ–∏ <span id="current-well-name"></span></h3>
          <div id="layers-list">
            <div class="empty-state">
              <p>üìù –ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å–ª–æ–µ–≤</p>
              <p><small>‚ûï –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π —Å–ª–æ–π</small></p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      class DrillingJournal {
        constructor() {
          this.dbName = 'DrillingJournal'
          this.dbVersion = 1
          this.currentWell = null
          this.init()
        }

        async init() {
          await this.initDB()
          this.setupEventListeners()
          this.loadWells()
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        async initDB() {
          return new Promise((resolve, reject) => {
            const request = indexedDB.open(this.dbName, this.dbVersion)

            request.onerror = () => reject(request.error)
            request.onsuccess = () => {
              this.db = request.result
              console.log('‚úÖ –ë–î –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞')
              resolve()
            }

            request.onupgradeneeded = (event) => {
              const db = event.target.result

              if (!db.objectStoreNames.contains('wells')) {
                const wellStore = db.createObjectStore('wells', {
                  keyPath: 'id',
                })
                wellStore.createIndex('name', 'name', { unique: false })
              }

              if (!db.objectStoreNames.contains('layers')) {
                const layerStore = db.createObjectStore('layers', {
                  keyPath: 'id',
                })
                layerStore.createIndex('wellId', 'wellId', { unique: false })
              }
            }
          })
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
        setupEventListeners() {
          // –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–∫–≤–∞–∂–∏–Ω—ã
          const wellForm = document.getElementById('new-well-form')
          if (wellForm) {
            wellForm.addEventListener('submit', (e) => {
              e.preventDefault()
              this.createWell(new FormData(e.target))
            })
          }

          // –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–ª–æ—è
          const layerForm = document.getElementById('new-layer-form')
          if (layerForm) {
            layerForm.addEventListener('submit', (e) => {
              e.preventDefault()
              this.createLayer(new FormData(e.target))
            })
          }
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –ë–î
        async saveToLocalDB(storeName, data) {
          return new Promise((resolve, reject) => {
            const transaction = this.db.transaction([storeName], 'readwrite')
            const store = transaction.objectStore(storeName)

            const itemWithId = {
              ...data,
              id:
                data.id ||
                `local_${Date.now()}_${Math.random()
                  .toString(36)
                  .substr(2, 9)}`,
              createdAt: new Date().toISOString(),
            }

            const request = store.put(itemWithId)

            request.onsuccess = () => resolve(itemWithId)
            request.onerror = (e) => reject(e)
          })
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î
        async loadFromLocalDB(storeName, indexName = null, value = null) {
          return new Promise((resolve, reject) => {
            const transaction = this.db.transaction([storeName], 'readonly')
            const store = transaction.objectStore(storeName)
            let request

            if (indexName && value !== null) {
              const index = store.index(indexName)
              request = index.getAll(value)
            } else {
              request = store.getAll()
            }

            request.onsuccess = () => resolve(request.result)
            request.onerror = (e) => reject(e)
          })
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ —Å–∫–≤–∞–∂–∏–Ω—ã
        async createWell(formData) {
          const wellData = {
            name: formData.get('name'),
            area: formData.get('area'),
            structure: formData.get('structure'),
            planned_depth: parseFloat(formData.get('planned_depth')) || 0,
          }

          try {
            await this.saveToLocalDB('wells', wellData)
            this.showMessage('‚úÖ –°–∫–≤–∞–∂–∏–Ω–∞ —Å–æ–∑–¥–∞–Ω–∞!', 'success')
            document.getElementById('new-well-form').reset()
            this.loadWells()
          } catch (error) {
            this.showMessage('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–∫–≤–∞–∂–∏–Ω—ã', 'error')
          }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ —Å–ª–æ—è
        async createLayer(formData) {
          const wellId = formData.get('well_id')
          const depthFrom = parseFloat(formData.get('depth_from'))
          const depthTo = parseFloat(formData.get('depth_to'))

          // –ë–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è —á–∏—Å–µ–ª
          if (isNaN(depthFrom) || isNaN(depthTo)) {
            this.showMessage('–ù–µ –∑–∞–±—É–¥—å –ø–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä—è—Ç—å —Å–µ–±—è', 'error')
            return
          }

          if (depthFrom < 0 || depthTo < 0) {
            this.showMessage('‚ùå –ì–ª—É–±–∏–Ω–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–π', 'error')
            return
          }

          if (depthFrom >= depthTo) {
            this.showMessage(
              '‚ùå –ì–ª—É–±–∏–Ω–∞ "–æ—Ç" –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –º–µ–Ω—å—à–µ –≥–ª—É–±–∏–Ω—ã "–¥–æ"',
              'error'
            )
            return
          }

          const layerData = {
            wellId: wellId,
            depth_from: depthFrom,
            depth_to: depthTo,
            lithology: formData.get('lithology'),
            description: formData.get('description'),
            thickness: (depthTo - depthFrom).toFixed(1),
            core_intervals: [], // –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω—è—Ç—å—Å—è –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
          }

          try {
            const savedLayer = await this.saveToLocalDB('layers', layerData)
            this.showMessage('‚úÖ –°–ª–æ–π –¥–æ–±–∞–≤–ª–µ–Ω!', 'success')
            document.getElementById('new-layer-form').reset()
            await this.loadWellLayers(wellId)

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ –∫–µ—Ä–Ω–∞
            setTimeout(() => this.editLayer(savedLayer.id), 500)
          } catch (error) {
            this.showMessage('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Å–ª–æ—è', 'error')
          }
        }

        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ª–æ—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞–º–∏ –∫–µ—Ä–Ω–∞
        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ª–æ—è (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
        async editLayer(layerId) {
            try {
                const layers = await this.loadFromLocalDB('layers');
                const wells = await this.loadFromLocalDB('wells');
                const layer = layers.find(l => l.id === layerId);
                
                if (!layer) {
                    this.showMessage('‚ùå –°–ª–æ–π –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                    return;
                }

                const well = wells.find(w => w.id === layer.wellId);

                // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                const modalHtml = `
                    <div class="modal-overlay" id="edit-layer-modal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;">
                        <div class="modal-content" style="background: white; padding: 20px; border-radius: 10px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
                            <h3>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ª–æ—è</h3>
                            <div style="margin-bottom: 15px; color: #666;">
                                –°–∫–≤–∞–∂–∏–Ω–∞: <strong>${well ? well.name : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</strong>
                            </div>
                            
                            <h4>üìè –û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</h4>
                            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                                <div style="flex: 1;">
                                    <label for="edit-depth-from">–û—Ç (–º)</label>
                                    <input type="number" id="edit-depth-from" value="${layer.depth_from}" step="0.1" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                                <div style="flex: 1;">
                                    <label for="edit-depth-to">–î–æ (–º)</label>
                                    <input type="number" id="edit-depth-to" value="${layer.depth_to}" step="0.1" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label for="edit-lithology">–õ–∏—Ç–æ–ª–æ–≥–∏—è</label>
                                <select id="edit-lithology" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="prs" ${layer.lithology === 'prs' ? 'selected' : ''}>üü´ –ü–†–°</option>
                                    <option value="peat" ${layer.lithology === 'peat' ? 'selected' : ''}>üü§ –¢–æ—Ä—Ñ</option>
                                    <option value="sand" ${layer.lithology === 'sand' ? 'selected' : ''}>üü° –ü–µ—Å–æ–∫</option>
                                    <option value="loam" ${layer.lithology === 'loam' ? 'selected' : ''}>üîµ –°—É–≥–ª–∏–Ω–æ–∫</option>
                                    <option value="sandy_loam" ${layer.lithology === 'sandy_loam' ? 'selected' : ''}>üü† –°—É–ø–µ—Å—å</option>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label for="edit-description">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                                <textarea id="edit-description" rows="2" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">${layer.description || ''}</textarea>
                            </div>
                            
                            <h4>üìã –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã –æ—Ç–±–æ—Ä–∞ –∫–µ—Ä–Ω–∞</h4>
                            <div style="font-size: 12px; color: #666; margin-bottom: 10px;">
                                <strong>–ü–æ–¥—Å–∫–∞–∑–∫–∞:</strong> –î–ª—è –º–æ–Ω–æ–ª–∏—Ç–æ–≤ —É–∫–∞–∂–∏—Ç–µ –¥–∏–∞–ø–∞–∑–æ–Ω, –¥–ª—è –Ω–∞—Ä—É—à–µ–Ω–Ω—ã—Ö –ø—Ä–æ–± - –æ–¥–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ
                            </div>
                            <div id="core-intervals-container" style="margin-bottom: 15px;">
                                ${this.renderCoreIntervalsForm(layer)}
                            </div>
                            
                            <button onclick="app.addCoreInterval('${layerId}')" class="btn" style="margin-bottom: 10px;">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª</button>
                            
                            <div class="action-buttons">
                                <button onclick="app.saveLayerChanges('${layerId}')" class="btn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                                <button onclick="app.closeEditModal()" class="btn btn-secondary">‚ùå –û—Ç–º–µ–Ω–∞</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–ª–æ—è:', error);
                this.showMessage('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–ª–æ—è', 'error');
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å–ª–æ—è
        async saveLayerChanges(layerId) {
            try {
                const layers = await this.loadFromLocalDB('layers');
                const layer = layers.find(l => l.id === layerId);
                
                if (!layer) {
                    this.showMessage('‚ùå –°–ª–æ–π –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                    return;
                }

                // –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                const depthFrom = parseFloat(document.getElementById('edit-depth-from').value);
                const depthTo = parseFloat(document.getElementById('edit-depth-to').value);
                
                // –í–∞–ª–∏–¥–∞—Ü–∏—è –≥–ª—É–±–∏–Ω—ã
                if (isNaN(depthFrom) || isNaN(depthTo) || depthFrom >= depthTo) {
                    this.showMessage('‚ùå –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –≥–ª—É–±–∏–Ω—ã', 'error');
                    return;
                }

                // –°–æ–±–∏—Ä–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –∫–µ—Ä–Ω–∞
                const coreIntervals = [];
                const intervalElements = document.querySelectorAll('.core-interval-item');
                
                intervalElements.forEach((element, index) => {
                    const fromInput = document.getElementById(`core-from-${index}`);
                    const toInput = document.getElementById(`core-to-${index}`);
                    const stateSelect = document.getElementById(`core-state-${index}`);
                    
                    const from = fromInput && fromInput.value !== '' ? parseFloat(fromInput.value) : null;
                    const to = toInput && toInput.value !== '' ? parseFloat(toInput.value) : null;
                    const state = stateSelect ? stateSelect.value : '—Ç';
                    
                    if (from !== null || to !== null) {
                        coreIntervals.push({ from, to, state });
                    }
                });

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ª–æ–π
                const updatedLayer = {
                    ...layer,
                    depth_from: depthFrom,
                    depth_to: depthTo,
                    lithology: document.getElementById('edit-lithology').value,
                    description: document.getElementById('edit-description').value,
                    thickness: (depthTo - depthFrom).toFixed(2),
                    core_intervals: coreIntervals
                };

                await this.saveToLocalDB('layers', updatedLayer);
                
                this.closeEditModal();
                this.showMessage('‚úÖ –°–ª–æ–π –æ–±–Ω–æ–≤–ª–µ–Ω!', 'success');
                await this.loadWellLayers(this.currentWell);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å–ª–æ—è:', error);
                this.showMessage('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å–ª–æ—è', 'error');
            }
        }

        // –†–µ–Ω–¥–µ—Ä —Ñ–æ—Ä–º—ã –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ –∫–µ—Ä–Ω–∞
        renderCoreIntervalsForm(layer) {
          if (!layer.core_intervals || layer.core_intervals.length === 0) {
            return '<div class="empty-state">–î–æ–±–∞–≤—å—Ç–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª –æ—Ç–±–æ—Ä–∞</div>'
          }

          return layer.core_intervals
            .map(
              (interval, index) => `
        <div class="core-interval-item" style="display: flex; flex-direction: row; gap: 4px; margin-bottom: 8px; align-items: center; padding: 8px; background: #f8f9fa; border-radius: 5px;">
            <div style="flex: 1; min-width: 0;">
                <input type="number" id="core-from-${index}" value="${
                interval.from !== null ? interval.from : ''
              }" step="0.1" placeholder="–û—Ç (–º)" style="width: 85%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="flex: 1; min-width: 0;">
                <input type="number" id="core-to-${index}" value="${
                interval.to !== null ? interval.to : ''
              }" step="0.1" placeholder="–î–æ (–º)" style="width: 85%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="flex: 0.8; min-width: 0;">
                <select id="core-state-${index}" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="—Ç" ${
                      interval.state === '—Ç' ? 'selected' : ''
                    }>–¢–∞–ª—ã–π</option>
                    <option value="–º" ${
                      interval.state === '–º' ? 'selected' : ''
                    }>–ú–µ—Ä–∑–ª—ã–π</option>
                </select>
            </div>
            <button type="button" onclick="app.removeCoreInterval('${
              layer.id
            }', ${index})" class="btn-delete-small" style="flex-shrink: 0;">üóëÔ∏è</button>
        </div>
        `
            )
            .join('')
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –∫–µ—Ä–Ω–∞
        addCoreInterval(layerId) {
          const container = document.getElementById('core-intervals-container')
          const index = container.querySelectorAll('.core-interval-item').length

          const newIntervalHtml = `
        <div class="core-interval-item" style="display: flex; flex-direction: row; gap: 4px; margin-bottom: 8px; align-items: center; padding: 8px; background: #f8f9fa; border-radius: 5px;">
            <div style="flex: 1; min-width: 0;">
                <input type="number" id="core-from-${index}" step="0.1" placeholder="–û—Ç (–º)" style="width: 85%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="flex: 1; min-width: 0;">
                <input type="number" id="core-to-${index}" step="0.1" placeholder="–î–æ (–º)" style="width: 85%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="flex: 0.8; min-width: 0;">
                <select id="core-state-${index}" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="—Ç">–¢–∞–ª—ã–π</option>
                    <option value="–º">–ú–µ—Ä–∑–ª—ã–π</option>
                </select>
            </div>
            <button type="button" onclick="this.parentElement.remove()" class="btn-delete-small" style="flex-shrink: 0;">üóëÔ∏è</button>
        </div>
        `

          container.insertAdjacentHTML('beforeend', newIntervalHtml)
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –∫–µ—Ä–Ω–∞
        async removeCoreInterval(layerId, index) {
          try {
            const layers = await this.loadFromLocalDB('layers')
            const layer = layers.find((l) => l.id === layerId)

            if (layer && layer.core_intervals) {
              layer.core_intervals.splice(index, 1)
              await this.saveToLocalDB('layers', layer)

              // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–æ—Ä–º—É
              const container = document.getElementById(
                'core-intervals-container'
              )
              container.innerHTML = this.renderCoreIntervalsForm(layer)
            }
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞:', error)
          }
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ –∫–µ—Ä–Ω–∞
        async saveLayerCoreIntervals(layerId) {
          try {
            const layers = await this.loadFromLocalDB('layers')
            const layer = layers.find((l) => l.id === layerId)

            if (!layer) {
              this.showMessage('‚ùå –°–ª–æ–π –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error')
              return
            }

            // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –∏–∑ —Ñ–æ—Ä–º—ã
            const coreIntervals = []
            const intervalElements = document.querySelectorAll(
              '.core-interval-item'
            )

            intervalElements.forEach((element, index) => {
              const fromInput = document.getElementById(`core-from-${index}`)
              const toInput = document.getElementById(`core-to-${index}`)
              const stateSelect = document.getElementById(`core-state-${index}`)

              const from =
                fromInput && fromInput.value !== ''
                  ? parseFloat(fromInput.value)
                  : null
              const to =
                toInput && toInput.value !== ''
                  ? parseFloat(toInput.value)
                  : null
              const state = stateSelect ? stateSelect.value : '—Ç' // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é "—Ç"

              // –í–∞–ª–∏–¥–∞—Ü–∏—è: –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω—ã –æ–±–∞ –∑–Ω–∞—á–µ–Ω–∏—è, –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ "–æ—Ç" –º–µ–Ω—å—à–µ "–¥–æ"
              if (from !== null && to !== null && from > to) {
                this.showMessage(
                  `‚ùå –í –∏–Ω—Ç–µ—Ä–≤–∞–ª–µ ${
                    index + 1
                  }: "–æ—Ç" (${from}) –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–µ–Ω—å—à–µ "–¥–æ" (${to})`,
                  'error'
                )
                return
              }

              // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ
              if (from !== null || to !== null) {
                coreIntervals.push({ from, to, state })
              }
            })

            layer.core_intervals = coreIntervals
            await this.saveToLocalDB('layers', layer)

            this.closeEditModal()
            this.showMessage('‚úÖ –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã –∫–µ—Ä–Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!', 'success')
            await this.loadWellLayers(this.currentWell)
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤:', error)
            this.showMessage('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏', 'error')
          }
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        closeEditModal() {
          const modal = document.getElementById('edit-layer-modal')
          if (modal) {
            modal.remove()
          }
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∫–ª–∞—Å—Å DrillingJournal:

        // –£–¥–∞–ª–µ–Ω–∏–µ —Å–∫–≤–∞–∂–∏–Ω—ã
        async deleteWell(wellId) {
          if (!confirm('–£–¥–∞–ª–∏—Ç—å —Å–∫–≤–∞–∂–∏–Ω—É –∏ –≤—Å–µ –µ—ë —Å–ª–æ–∏?')) return

          try {
            // –£–¥–∞–ª—è–µ–º —Å–∫–≤–∞–∂–∏–Ω—É
            await this.deleteFromLocalDB('wells', wellId)

            // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å–ª–æ–∏ —ç—Ç–æ–π —Å–∫–≤–∞–∂–∏–Ω—ã
            const allLayers = await this.loadFromLocalDB('layers')
            const wellLayers = allLayers.filter(
              (layer) => layer.wellId === wellId
            )

            for (const layer of wellLayers) {
              await this.deleteFromLocalDB('layers', layer.id)
            }

            this.showMessage('‚úÖ –°–∫–≤–∞–∂–∏–Ω–∞ —É–¥–∞–ª–µ–Ω–∞', 'success')
            this.loadWells()
          } catch (error) {
            this.showMessage('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏', 'error')
          }
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ —Å–ª–æ—è
        async deleteLayer(layerId) {
          if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Å–ª–æ–π?')) return

          try {
            await this.deleteFromLocalDB('layers', layerId)
            this.showMessage('‚úÖ –°–ª–æ–π —É–¥–∞–ª–µ–Ω', 'success')
            this.loadWellLayers(this.currentWell)
          } catch (error) {
            this.showMessage('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏', 'error')
          }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–∫–≤–∞–∂–∏–Ω
        async loadWells() {
          try {
            const wells = await this.loadFromLocalDB('wells')
            this.renderWells(wells)
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫–≤–∞–∂–∏–Ω:', error)
          }
        }

        // –ú–ï–¢–û–î –£–î–ê–õ–ï–ù–ò–Ø –ò–ó –õ–û–ö–ê–õ–¨–ù–û–ô –ë–î
        async deleteFromLocalDB(storeName, id) {
          return new Promise((resolve, reject) => {
            const transaction = this.db.transaction([storeName], 'readwrite')
            const store = transaction.objectStore(storeName)
            const request = store.delete(id)

            request.onsuccess = () => {
              console.log(`üóëÔ∏è –£–¥–∞–ª–µ–Ω –∏–∑ ${storeName}:`, id)
              resolve()
            }
            request.onerror = (e) => {
              console.error(`‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ ${storeName}:`, e)
              reject(e)
            }
          })
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ª–æ–µ–≤ —Å–∫–≤–∞–∂–∏–Ω—ã
        async loadWellLayers(wellId) {
          try {
            const layers = await this.loadFromLocalDB(
              'layers',
              'wellId',
              wellId
            )
            this.renderLayers(layers)
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ–µ–≤:', error)
          }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–∫–≤–∞–∂–∏–Ω
        renderWells(wells) {
            const container = document.getElementById('wells-list');

            if (!wells || wells.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>üìù –ù–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Å–∫–≤–∞–∂–∏–Ω</p>
                        <p><small>–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é —Å–∫–≤–∞–∂–∏–Ω—É</small></p>
                    </div>
                `;
                return;
            }

            container.innerHTML = wells
                .map(
                    (well) => `
                    <div class="well-card">
                        <div onclick="app.showWorkPage('${well.id}')" style="flex-grow: 1; cursor: pointer;">
                            <h3>${well.name}</h3>
                            <div class="well-meta">
                                <p>üìç ${well.area}</p>
                                ${well.structure ? `<p>üèóÔ∏è ${well.structure}</p>` : ''}
                                ${well.planned_depth ? `<p>üìè ${well.planned_depth} –º</p>` : ''}
                            </div>
                            <small>üìÖ ${new Date(well.createdAt).toLocaleDateString('ru-RU')}</small>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 5px;">
                            <button class="btn-copy" onclick="app.copyWell('${well.id}')" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–∫–≤–∞–∂–∏–Ω—É">üìã</button>
                            <button class="btn-edit" onclick="app.editWell('${well.id}')" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∫–≤–∞–∂–∏–Ω—É">‚úèÔ∏è</button>
                            <button class="btn-delete" onclick="app.deleteWell('${well.id}')" title="–£–¥–∞–ª–∏—Ç—å —Å–∫–≤–∞–∂–∏–Ω—É">üóëÔ∏è</button>
                        </div>
                    </div>
                `
                )
                .join('');
        }

        // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∫–≤–∞–∂–∏–Ω—ã
        async copyWell(wellId) {
            try {
                const wells = await this.loadFromLocalDB('wells');
                const layers = await this.loadFromLocalDB('layers');
                
                const originalWell = wells.find(w => w.id === wellId);
                if (!originalWell) {
                    this.showMessage('‚ùå –°–∫–≤–∞–∂–∏–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
                    return;
                }

                // –°–æ–∑–¥–∞–µ–º –∫–æ–ø–∏—é —Å–∫–≤–∞–∂–∏–Ω—ã
                const copiedWell = {
                    ...originalWell,
                    id: `local_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    name: `${originalWell.name} (–∫–æ–ø–∏—è)`,
                    createdAt: new Date().toISOString()
                };

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–ø–∏—é —Å–∫–≤–∞–∂–∏–Ω—ã
                await this.saveToLocalDB('wells', copiedWell);

                // –ö–æ–ø–∏—Ä—É–µ–º –≤—Å–µ —Å–ª–æ–∏ —Å–∫–≤–∞–∂–∏–Ω—ã
                const wellLayers = layers.filter(layer => layer.wellId === wellId);
                for (const layer of wellLayers) {
                    const copiedLayer = {
                        ...layer,
                        id: `local_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                        wellId: copiedWell.id,
                        createdAt: new Date().toISOString()
                    };
                    await this.saveToLocalDB('layers', copiedLayer);
                }

                this.showMessage('‚úÖ –°–∫–≤–∞–∂–∏–Ω–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!', 'success');
                this.loadWells();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–∫–≤–∞–∂–∏–Ω—ã:', error);
                this.showMessage('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–∫–≤–∞–∂–∏–Ω—ã', 'error');
            }
        }

        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∫–≤–∞–∂–∏–Ω—ã
        async editWell(wellId) {
            try {
                const wells = await this.loadFromLocalDB('wells');
                const well = wells.find(w => w.id === wellId);
                
                if (!well) {
                    this.showMessage('‚ùå –°–∫–≤–∞–∂–∏–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
                    return;
                }

                // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∫–≤–∞–∂–∏–Ω—ã
                const modalHtml = `
                    <div class="modal-overlay" id="edit-well-modal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;">
                        <div class="modal-content" style="background: white; padding: 20px; border-radius: 10px; max-width: 500px; width: 90%;">
                            <h3>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∫–≤–∞–∂–∏–Ω—ã</h3>
                            <form id="edit-well-form">
                                <div class="form-group">
                                    <label for="edit-well-name">–ù–∞–∑–≤–∞–Ω–∏–µ —Å–∫–≤–∞–∂–∏–Ω—ã *</label>
                                    <input type="text" id="edit-well-name" value="${well.name}" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                </div>
                                <div class="form-group">
                                    <label for="edit-well-area">–£—á–∞—Å—Ç–æ–∫ *</label>
                                    <input type="text" id="edit-well-area" value="${well.area}" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                </div>
                                <div class="form-group">
                                    <label for="edit-well-structure">–°–æ–æ—Ä—É–∂–µ–Ω–∏–µ</label>
                                    <input type="text" id="edit-well-structure" value="${well.structure || ''}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                </div>
                                <div class="form-group">
                                    <label for="edit-well-depth">–ü—Ä–æ–µ–∫—Ç–Ω–∞—è –≥–ª—É–±–∏–Ω–∞ (–º) *</label>
                                    <input type="number" id="edit-well-depth" value="${well.planned_depth || 0}" step="0.1" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                </div>
                                <div class="action-buttons">
                                    <button type="submit" class="btn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                                    <button type="button" onclick="app.closeEditWellModal()" class="btn btn-secondary">‚ùå –û—Ç–º–µ–Ω–∞</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã
                document.getElementById('edit-well-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveWellChanges(wellId);
                });
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–∫–≤–∞–∂–∏–Ω—ã:', error);
                this.showMessage('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–∫–≤–∞–∂–∏–Ω—ã', 'error');
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å–∫–≤–∞–∂–∏–Ω—ã
        async saveWellChanges(wellId) {
            try {
                const wells = await this.loadFromLocalDB('wells');
                const well = wells.find(w => w.id === wellId);
                
                if (!well) {
                    this.showMessage('‚ùå –°–∫–≤–∞–∂–∏–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
                    return;
                }

                const updatedWell = {
                    ...well,
                    name: document.getElementById('edit-well-name').value,
                    area: document.getElementById('edit-well-area').value,
                    structure: document.getElementById('edit-well-structure').value,
                    planned_depth: parseFloat(document.getElementById('edit-well-depth').value) || 0
                };

                await this.saveToLocalDB('wells', updatedWell);
                
                this.closeEditWellModal();
                this.showMessage('‚úÖ –°–∫–≤–∞–∂–∏–Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!', 'success');
                this.loadWells();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å–∫–≤–∞–∂–∏–Ω—ã:', error);
                this.showMessage('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å–∫–≤–∞–∂–∏–Ω—ã', 'error');
            }
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∫–≤–∞–∂–∏–Ω—ã
        closeEditWellModal() {
            const modal = document.getElementById('edit-well-modal');
            if (modal) {
                modal.remove();
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ª–æ–µ–≤
        renderLayers(layers) {
          const container = document.getElementById('layers-list')

          if (!layers || layers.length === 0) {
            container.innerHTML = `
            <div class="empty-state">
                <p>üìù –ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å–ª–æ–µ–≤</p>
                <p><small>–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π —Å–ª–æ–π</small></p>
            </div>
        `
            return
          }

          // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Å–ª–æ–∏ –ø–æ –≥–ª—É–±–∏–Ω–µ
          layers.sort(
            (a, b) => parseFloat(a.depth_from) - parseFloat(b.depth_from)
          )

          container.innerHTML = layers
            .map(
              (layer) => `
            <div class="layer-item">
                <div class="layer-info">
                    <div class="layer-depth">
                        ${layer.depth_from} - ${layer.depth_to} –º
                    </div>
                    <div class="layer-lithology">
                        <span class="lithology-badge ${layer.lithology}">
                            ${this.getLithologyDisplay(layer.lithology)}
                        </span>
                        ${layer.description || ''}
                    </div>
                    ${this.renderCoreIntervals(layer)}
                </div>
                <div class="layer-actions">
                    <div class="layer-thickness">
                        ${layer.thickness} –º
                    </div>
                    <button class="btn-edit-small" onclick="app.editLayer('${
                      layer.id
                    }')" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –∫–µ—Ä–Ω–∞">‚úèÔ∏è</button>
                    <button class="btn-delete-small" onclick="app.deleteLayer('${
                      layer.id
                    }')" title="–£–¥–∞–ª–∏—Ç—å —Å–ª–æ–π">üóëÔ∏è</button>
                </div>
            </div>
        `
            )
            .join('')
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ –∫–µ—Ä–Ω–∞
        renderCoreIntervals(layer) {
          if (!layer.core_intervals || layer.core_intervals.length === 0) {
            return ''
          }

          const intervalsHtml = layer.core_intervals
            .map((interval) => {
              let intervalText = ''
              if (interval.from !== null && interval.to !== null) {
                intervalText = `${interval.from}-${interval.to} –º`
              } else if (interval.from !== null) {
                intervalText = `${interval.from} –º`
              } else if (interval.to !== null) {
                intervalText = `${interval.to} –º`
              } else {
                intervalText = `–Ω–∞—Ä—É—à–µ–Ω–Ω—ã–π`
              }

              // –î–æ–±–∞–≤–ª—è–µ–º –∑–Ω–∞—á–æ–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è
              const stateIcon = interval.state === '–º' ? ' ‚ùÑÔ∏è' : ''

              return `üî¨ ${intervalText}${stateIcon}`
            })
            .join('<br>')

          return `<div class="layer-core" style="margin-top: 5px; color: #27ae60; font-size: 14px;">
        ${intervalsHtml}
    </div>`
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏—è –ª–∏—Ç–æ–ª–æ–≥–∏–∏
        getLithologyDisplay(lithology) {
          const lithologyMap = {
            prs: '–ü–†–°',
            peat: '–¢–æ—Ä—Ñ',
            sand: '–ü–µ—Å–æ–∫',
            loam: '–°—É–≥–ª–∏–Ω–æ–∫',
            sandy_loam: '–°—É–ø–µ—Å—å',
          }
          return lithologyMap[lithology] || lithology
        }

        // –ü–æ–∫–∞–∑ —Å–æ–æ–±—â–µ–Ω–∏–π
        showMessage(text, type = 'info') {
          // –ü—Ä–æ—Å—Ç–æ–π alert –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
          alert(text)
        }

        // –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
        async exportData() {
          try {
            const wells = await this.loadFromLocalDB('wells')
            const layers = await this.loadFromLocalDB('layers')

            if (wells.length === 0) {
              this.showMessage('‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'error')
              return
            }

            // –°–æ–∑–¥–∞–µ–º Excel —Ñ–∞–π–ª
            const workbook = this.createExcelWorkbook(wells, layers)

            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —Å–æ–∑–¥–∞–µ–º –∞–∫—Ç –æ—Ç–±–æ—Ä–∞ –∫–µ—Ä–Ω–∞
            this.createCoreSamplingAct(workbook, wells, layers)

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏ —Å–∫–∞—á–∏–≤–∞–µ–º
            this.downloadExcel(workbook, '–±—É—Ä–æ–≤–æ–π_–∂—É—Ä–Ω–∞–ª.xlsx')

            this.showMessage('‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω!', 'success')
          } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:', error)
            this.showMessage('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –¥–∞–Ω–Ω—ã—Ö', 'error')
          }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –∞–∫—Ç–∞ –æ—Ç–±–æ—Ä–∞ –∫–µ—Ä–Ω–∞
        createCoreSamplingAct(workbook, wells, layers) {
          const coreSamples = []
          let sampleNumber = 1

          // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É —Å–∫–≤–∞–∂–∏–Ω –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
          const wellMap = {}
          wells.forEach((well) => {
            wellMap[well.id] = well
          })

          // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –æ–±—Ä–∞–∑—Ü—ã –∫–µ—Ä–Ω–∞ –∏–∑ –≤—Å–µ—Ö —Å–ª–æ–µ–≤
          layers.forEach((layer) => {
            if (layer.core_intervals && layer.core_intervals.length > 0) {
              const well = wellMap[layer.wellId]

              layer.core_intervals.forEach((interval) => {
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª –æ–¥–∏–Ω–æ—á–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º
                const isSingleValue =
                  (interval.from !== null && interval.to === null) ||
                  (interval.from === null && interval.to !== null) ||
                  (interval.from !== null &&
                    interval.to !== null &&
                    interval.from === interval.to)

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É: –¥–ª—è –æ–¥–∏–Ω–æ—á–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π - "–Ω", –¥–ª—è –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ - "–ø"
                const structure = isSingleValue ? '–Ω' : '–ø'

                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≥–ª—É–±–∏–Ω—É –æ—Ç–±–æ—Ä–∞
                let depthInterval = ''
                if (
                  interval.from !== null &&
                  interval.to !== null &&
                  interval.from !== interval.to
                ) {
                  depthInterval = `${interval.from}-${interval.to}`
                } else if (interval.from !== null) {
                  depthInterval = `${interval.from}`
                } else if (interval.to !== null) {
                  depthInterval = `${interval.to}`
                } else {
                  depthInterval = '–Ω–∞—Ä—É—à–µ–Ω–Ω—ã–π'
                }

                const sample = {
                  '‚Ññ –æ–±—Ä–∞–∑—Ü–∞ (–ø—Ä–æ–±—ã)': sampleNumber++,
                  –î–∞—Ç–∞: new Date(layer.createdAt).toLocaleDateString('ru-RU'),
                  '–¢–æ—á–∫–∞ –æ—Ç–±–æ—Ä–∞ –æ–±—Ä–∞–∑—Ü–∞': well ? well.name : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
                  '–ì–ª—É–±–∏–Ω–∞ –æ—Ç–±–æ—Ä–∞ –æ–±—Ä–∞–∑—Ü–∞ (–ø—Ä–æ–±—ã)': depthInterval.replace(
                    /\./g,
                    ','
                  ),
                  '–°–æ—Å—Ç–æ—è–Ω–∏–µ –æ–±—Ä–∞–∑—Ü–∞ (–ø—Ä–æ–±—ã) —Ç–∞–ª—ã–π/–º–µ—Ä–∑–ª—ã–π(—Ç/–º)':
                    interval.state || '—Ç', // –ë–µ—Ä–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                  '–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ–±—Ä–∞–∑—Ü–∞ (–ø—Ä–æ–±—ã)(–ø/–Ω)': structure,
                  '–ü–æ–ª–µ–≤–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–∑—Ü–∞(–ø—Ä–æ–±—ã)':
                    this.getLithologyDisplay(layer.lithology),
                }
                coreSamples.push(sample)
              })
            }
          })

          if (coreSamples.length > 0) {
            const coreSheet = XLSX.utils.json_to_sheet(coreSamples)
            XLSX.utils.book_append_sheet(
              workbook,
              coreSheet,
              '–ê–∫—Ç –æ—Ç–±–æ—Ä–∞ –∫–µ—Ä–Ω–∞'
            )
          }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ Excel —Ñ–∞–π–ª–∞
        createExcelWorkbook(wells, layers) {
            const workbook = XLSX.utils.book_new();

            // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É —Å–∫–≤–∞–∂–∏–Ω –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
            const wellMap = {};
            wells.forEach((well) => {
                wellMap[well.id] = well;
            });

            // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ª–∏—Å—Ç–∞ —Å–∫–≤–∞–∂–∏–Ω —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –∫–æ–ª–æ–Ω–∫–∞–º–∏
            const wellsData = wells.map((well) => {
                // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —Å–ª–æ–∏ —ç—Ç–æ–π —Å–∫–≤–∞–∂–∏–Ω—ã
                const wellLayers = layers.filter(layer => layer.wellId === well.id);
                
                // –í—ã—á–∏—Å–ª—è–µ–º —Ñ–∞–∫—Ç–∏—á–µ—Å–∫—É—é –≥–ª—É–±–∏–Ω—É (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≥–ª—É–±–∏–Ω–∞ "–¥–æ" —Å—Ä–µ–¥–∏ —Å–ª–æ–µ–≤)
                const actualDepth = wellLayers.length > 0 
                    ? Math.max(...wellLayers.map(layer => parseFloat(layer.depth_to)))
                    : 0;

                // –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–æ–Ω–æ–ª–∏—Ç–æ–≤ –∏ –Ω–∞—Ä—É—à–µ–Ω–Ω—ã—Ö –æ–±—Ä–∞–∑—Ü–æ–≤
                let monolithCount = 0;
                let disturbedCount = 0;

                wellLayers.forEach(layer => {
                    if (layer.core_intervals && layer.core_intervals.length > 0) {
                        layer.core_intervals.forEach(interval => {
                            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª –æ–¥–∏–Ω–æ—á–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º
                            const isSingleValue = (interval.from !== null && interval.to === null) || 
                                                (interval.from === null && interval.to !== null) ||
                                                (interval.from !== null && interval.to !== null && interval.from === interval.to);

                            // –°—á–∏—Ç–∞–µ–º –º–æ–Ω–æ–ª–∏—Ç—ã (–¥–∏–∞–ø–∞–∑–æ–Ω—ã) –∏ –Ω–∞—Ä—É—à–µ–Ω–Ω—ã–µ (–æ–¥–∏–Ω–æ—á–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è)
                            if (isSingleValue) {
                                disturbedCount++;
                            } else {
                                monolithCount++;
                            }
                        });
                    }
                });

              return {
                  '–ù–∞–∑–≤–∞–Ω–∏–µ': well.name,
                  '–£—á–∞—Å—Ç–æ–∫': well.area,
                  '–°–æ–æ—Ä—É–∂–µ–Ω–∏–µ': well.structure || '',
                  '–ü—Ä–æ–µ–∫—Ç–Ω–∞—è –≥–ª—É–±–∏–Ω–∞, –º': well.planned_depth || 0,
                  '–§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –≥–ª—É–±–∏–Ω–∞, –º': actualDepth,
                  '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–æ–Ω–æ–ª–∏—Ç–æ–≤': monolithCount,
                  '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞—Ä—É—à–µ–Ω–Ω—ã—Ö –æ–±—Ä–∞–∑—Ü–æ–≤': disturbedCount,
                  '–í—Å–µ–≥–æ –æ–±—Ä–∞–∑—Ü–æ–≤': monolithCount + disturbedCount, // –ù–æ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞
                  '–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è': new Date(well.createdAt).toLocaleDateString('ru-RU'),
              };
            });

            const wellsSheet = XLSX.utils.json_to_sheet(wellsData);
            XLSX.utils.book_append_sheet(workbook, wellsSheet, '–°–∫–≤–∞–∂–∏–Ω—ã');

            // –õ–∏—Å—Ç —Å–æ —Å–ª–æ—è–º–∏ (–æ—Å—Ç–∞–≤–ª—è–µ–º –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
            const layersData = layers.map((layer) => {
                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –∫–µ—Ä–Ω–∞
                const coreIntervals = layer.core_intervals && layer.core_intervals.length > 0 
                    ? layer.core_intervals.map(interval => {
                        if (interval.from !== null && interval.to !== null && interval.from !== interval.to) {
                            return `${interval.from}-${interval.to}`;
                        } else if (interval.from !== null) {
                            return `${interval.from}`;
                        } else if (interval.to !== null) {
                            return `${interval.to}`;
                        }
                        return '–Ω–∞—Ä—É—à–µ–Ω–Ω—ã–π';
                    }).join('; ')
                    : '';

                return {
                    '–°–∫–≤–∞–∂–∏–Ω–∞': wellMap[layer.wellId] ? wellMap[layer.wellId].name : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
                    '–ì–ª—É–±–∏–Ω–∞ –æ—Ç, –º': layer.depth_from,
                    '–ì–ª—É–±–∏–Ω–∞ –¥–æ, –º': layer.depth_to,
                    '–ú–æ—â–Ω–æ—Å—Ç—å, –º': layer.thickness,
                    '–ò–Ω—Ç–µ—Ä–≤–∞–ª—ã –∫–µ—Ä–Ω–∞': coreIntervals,
                    '–õ–∏—Ç–æ–ª–æ–≥–∏—è': this.getLithologyDisplay(layer.lithology),
                    '–û–ø–∏—Å–∞–Ω–∏–µ': layer.description || '',
                    '–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è': new Date(layer.createdAt).toLocaleDateString('ru-RU'),
                };
            });

            const layersSheet = XLSX.utils.json_to_sheet(layersData);
            XLSX.utils.book_append_sheet(workbook, layersSheet, '–ì–µ–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Å–ª–æ–∏');

            return workbook;
        }

        // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ Excel —Ñ–∞–π–ª–∞
        downloadExcel(workbook, filename) {
          const excelBuffer = XLSX.write(workbook, {
            bookType: 'xlsx',
            type: 'array',
          })

          const blob = new Blob([excelBuffer], {
            type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
          })

          const url = URL.createObjectURL(blob)
          const link = document.createElement('a')
          link.href = url
          link.download = filename
          document.body.appendChild(link)
          link.click()
          document.body.removeChild(link)
          URL.revokeObjectURL(url)
        }

        // –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–∞–±–æ—Ç—ã —Å–æ —Å–∫–≤–∞–∂–∏–Ω–æ–π
        async showWorkPage(wellId) {
          this.currentWell = wellId
          document.getElementById('current-well-id').value = wellId

          await this.loadWellDetails(wellId)
          await this.loadWellLayers(wellId)
          showPage('work-page')
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–µ—Ç–∞–ª–µ–π —Å–∫–≤–∞–∂–∏–Ω—ã
        async loadWellDetails(wellId) {
          try {
            const wells = await this.loadFromLocalDB('wells')
            const well = wells.find((w) => w.id === wellId)

            if (well) {
              document.getElementById('working-well-name').textContent =
                well.name
              document.getElementById('working-well-info').textContent = `${
                well.area
              }${well.structure ? ' ‚Ä¢ ' + well.structure : ''}`
              document.getElementById('current-well-name').textContent =
                well.name
            }
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π —Å–∫–≤–∞–∂–∏–Ω—ã:', error)
          }
        }
      }

      // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
      function showPage(pageId) {
        document.querySelectorAll('.page').forEach((page) => {
          page.classList.remove('active')
        })
        document.getElementById(pageId).classList.add('active')
      }

      function exportData() {
        app.exportData()
      }

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
      let app
      document.addEventListener('DOMContentLoaded', () => {
        app = new DrillingJournal()
      })
    </script>
    <footer
      style="
        text-align: center;
        padding: 20px;
        margin-top: 30px;
        color: #7f8c8d;
        font-size: 14px;
        border-top: 1px solid #ecf0f1;
      "
    >
      <div style="max-width: 500px; margin: 0 auto">
        <p>
          üöÄ –†–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–æ —Å –ø–æ–º–æ—â—å—é
          <a
            href="https://openai.com"
            target="_blank"
            style="color: #3498db; text-decoration: none"
          >
            OpenAI
          </a>
          <p>
            ‚Ä¢ üìß –°–≤—è–∑—å:
            <a
              href="ural@ataullin.ru"
              style="color: #3498db; text-decoration: none"
            >
              ural@ataullin.ru
            </a>–£—Ä–∞–ª –ê—Ç–∞—É–ª–ª–∏–Ω 
          </p>
        </p>
        <p style="font-size: 12px; margin-top: 8px">
          üí° –≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –±—É—Ä–æ–≤–æ–π –∂—É—Ä–Ω–∞–ª –¥–ª—è –ø–æ–ª–µ–≤—ã—Ö –≥–µ–æ–ª–æ–≥–æ–≤
        </p>
      </div>
    </footer>
  </body>
</html>
